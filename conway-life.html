<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>conway-life</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora&display=swap"
      rel="stylesheet"
    />
    <style>
      #heading {
        font-family: "Lora", serif;
      }
    </style>
  </head>
  <body>
    <h1 id="heading">Conway's Game of Life</h1>
    <div class="board"></div>
    <div class="buttons">
      <button type="button" name="nextRound">下一轮</button>
      <button type="button" name="auto">自动演化</button>
      <button type="button" name="stop">停止演化</button>
      <button type="button" name="random">随机</button>
      <button type="button" name="clear">清空</button>
    </div>

    <script>
      let NUM_OF_ROWS;
      let NUM_OF_COLS;
      let TOTAL_NUMBER_OF_CELLS;
      let INITIAL_NUMBER_OF_LIVING_CELLS = 20;
      let gridArray;
      let animationID;
      let period = 300;
      const randomButton = document.querySelector('button[name="random"]');
      const nextRoundButton = document.querySelector(
        'button[name="nextRound"]'
      );
      const autoButton = document.querySelector('button[name="auto"]');
      const stopButton = document.querySelector('button[name="stop"]');
      const clearButton = document.querySelector('button[name="clear"]');
      const board = document.querySelector(".board");

      function initializeCheckboxes(rows = 10, cols = 10) {
        if (!isNaN(rows) && !isNaN(cols)) {
          rows = Math.abs(Number(rows.toFixed(0)));
          cols = Math.abs(Number(cols.toFixed(0)));
        } else {
          rows = 10;
          cols = 10;
        }

        NUM_OF_ROWS = rows;
        NUM_OF_COLS = cols;
        TOTAL_NUMBER_OF_CELLS = NUM_OF_ROWS * NUM_OF_COLS;
        for (let i = 0; i < rows; i++) {
          const row = document.createElement("div");
          row.setAttribute("data-row", `${i}`);
          makeOneRowOfCheckboxes(row, i, NUM_OF_COLS);
          board.appendChild(row);
        }
      }

      function makeOneRowOfCheckboxes(elementNode, row, cols) {
        for (let i = 0; i < cols; i++) {
          const checkbox = document.createElement("input");
          checkbox.setAttribute("type", "checkbox");
          checkbox.setAttribute("data-row", `${row}`);
          checkbox.setAttribute("data-col", `${i}`);
          elementNode.appendChild(checkbox);
        }
      }

      /**
       * 初始化 gridArray 变量
       */
      function makeGrid() {
        const grid = document.querySelectorAll(".board > [data-row]");
        gridArray = Array.from(grid);

        for (let i = 0; i < gridArray.length; i++) {
          gridArray[i] = Array.from(gridArray[i].children);
        }
      }

      /**
       * 重置整个棋盘，亦即把网页上所有的框都取消勾选
       */
      function resetCheckedCheckboxes() {
        for (let i = 0; i < gridArray.length; i++) {
          for (let j = 0; j < gridArray[i].length; j++) {
            gridArray[i][j].checked = null;
          }
        }
      }

      function sample(lo, hi, k) {
        const res = [];

        for (let i = 0; i < k; i++) {
          res[i] = lo + i;
        }

        let i = k;

        while (i < hi - lo) {
          i++;
          const j = Math.floor(Math.random() * i);

          if (j < k) {
            res[j] = lo + i - 1;
          }
        }

        return res;
      }

      function chooseLivingCells(indices) {
        for (let index of Object.values(indices)) {
          gridArray[Math.floor(index / gridArray[0].length)][
            index % gridArray[0].length
          ].checked = "checked";
        }
      }

      function randomlySelectCheckboxes() {
        resetCheckedCheckboxes();
        chooseLivingCells(
          sample(0, TOTAL_NUMBER_OF_CELLS, INITIAL_NUMBER_OF_LIVING_CELLS)
        );
      }

      function makeCurrentStateArray() {
        const currentState = [];
        let currentRowState = [];

        for (let i = 0; i < gridArray.length; i++) {
          for (let j = 0; j < gridArray[i].length; j++) {
            currentRowState[j] = Boolean(gridArray[i][j].checked) ? 1 : 0;
          }
          currentState.push(currentRowState.slice());
          currentRowState = [];
        }

        return currentState;
      }

      function generateNextStateArray(currState) {
        const NUM_OF_ROWS = currState.length;
        const NUM_OF_COLS = currState[0].length;
        const nextState = [];
        const row = Array(NUM_OF_COLS).fill(0);

        for (let i = 0; i < NUM_OF_ROWS; i++) {
          nextState.push(row.slice());
        }

        for (let i = 0; i < NUM_OF_ROWS; i++) {
          for (let j = 0; j < NUM_OF_COLS; j++) {
            const neighbours = [];
            neighbours[0] = currState[i - 1]?.[j - 1] ?? 0;
            neighbours[1] = currState[i - 1]?.[j] ?? 0;
            neighbours[2] = currState[i - 1]?.[j + 1] ?? 0;
            neighbours[3] = currState[i][j + 1] ?? 0;
            neighbours[4] = currState[i + 1]?.[j + 1] ?? 0;
            neighbours[5] = currState[i + 1]?.[j] ?? 0;
            neighbours[6] = currState[i + 1]?.[j - 1] ?? 0;
            neighbours[7] = currState[i][j - 1] ?? 0;
            const numOfLivingNeighbours = neighbours.reduce((prev, curr) => {
              return prev + curr;
            }, 0);

            if (currState[i][j] === 1) {
              if (numOfLivingNeighbours === 2 || numOfLivingNeighbours === 3) {
                nextState[i][j] = 1;
              }
            } else if (currState[i][j] === 0) {
              if (numOfLivingNeighbours === 3) {
                nextState[i][j] = 1;
              }
            }
          }
        }

        return nextState;
      }

      function nextRoundGrid() {
        const nextState = generateNextStateArray(
          makeCurrentStateArray(gridArray)
        );

        resetCheckedCheckboxes();

        for (let i = 0; i < NUM_OF_ROWS; i++) {
          for (let j = 0; j < NUM_OF_COLS; j++) {
            if (nextState[i][j] === 1) {
              gridArray[i][j].checked = "checked";
            }
          }
        }
      }

      function automaticallyEvolve(time) {
        if (animationID == undefined) {
          animationID = setInterval(nextRoundGrid, time);
        }
      }

      function stopautomaticallyEvolve() {
        if (animationID != undefined) {
          clearInterval(animationID);
          animationID = undefined;
        }
      }

      initializeCheckboxes();
      window.addEventListener("DOMContentLoaded", makeGrid);
      randomButton.addEventListener("click", randomlySelectCheckboxes);
      nextRoundButton.addEventListener("click", nextRoundGrid);
      autoButton.addEventListener("click", function outerautomaticallyEvolve() {
        automaticallyEvolve(period);
      });
      stopButton.addEventListener("click", stopautomaticallyEvolve);
      clearButton.addEventListener("click", function clearTheBoard() {
        stopautomaticallyEvolve();
        resetCheckedCheckboxes();
      });
    </script>
  </body>
</html>
